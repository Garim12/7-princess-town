<!DOCTYPE html>
<html lang="en">
<head>
    <!-- js Cookie -->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>게시글 수정 페이지</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .content {
            display: flex;
            width: 50%
        }

        .sidebar {
            padding: 20px;
            background-color: #f2f2f2;
            min-width: 200px;
        }

        .main-content {
            flex: 1;
            max-width: 600px; /* Adjust the width as needed */
            margin: 0 auto;
        }

        .h2 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .box {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .board-list, .search-ranking {
            list-style: none;
            padding: 0;
            margin: 0; /* remove default margin for ul/ol */
        }

        .board-list li, .search-ranking li {
            margin-bottom: 10px;
            cursor: pointer;
        }

        .board-list li:last-child, .search-ranking li:last-child {
            margin-bottom: 0;
        }


        label {
            display: block;
            margin-bottom: 5px;
        }

        input, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .custom-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .custom-select {
            flex: 1;
            max-width: 200px;
        }

        /*button {*/
        /*    padding: 10px 20px;*/
        /*    background-color: #007bff;*/
        /*    color: #fff;*/
        /*    border: none;*/
        /*    cursor: pointer;*/
        /*}*/

        /* 이미지 업로드 및 미리보기 스타일 */
        .image-upload-div, .image-preview-div {
            margin-bottom: 15px;
        }

        /* 이미지 미리보기 스타일 */
        #imagePreview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div class="content">
    <div class="sidebar">
        <div class="box">
            <h2 class="h2">인기검색어</h2>
            <ol class="search-ranking">
            </ol>
        </div>
        <div>
            <ul class="board-list">
                <li><a href="/view/mainpage">전체게시판</a></li>
                <!-- 백엔드에서 가져온 게시판 목록을 순회하면서 출력 -->
                <th:block th:each="board : ${boardList}">
                    <li><a th:href="@{/view/boards/{boardId}(boardId=${board.id})}" th:text="${board.title}">게시판</a></li>
                </th:block>
            </ul>
        </div>
    </div>
    <div class="main-content">
        <h2 class="h2">게시판 선택</h2>
        <form id="selectPostForm" enctype="multipart/form-data">
            <div class="custom-container">
                <select id="boardId" name="boardId" class="custom-select">
                    <option value="" selected disabled>게시판을 선택하세요</option>
                    <!-- 백엔드에서 가져온 게시판 목록을 순회하면서 출력 -->
                    <th:block th:each="board : ${boardList}">
                        <option th:value="${board.id}" th:text="${board.title}"></option>
                    </th:block>
                </select><br>
                <button type="button" id="selectBoardButton">게시판 선택 확인</button>
            </div>
        </form>
        <h2 class="h2">게시글 작성</h2>
        <form id="editPostForm" enctype="multipart/form-data">
            <label for="postTitle">제목:</label>
            <input type="text" id="postTitle" name="title" required><br>
            <label for="postContents">내용:</label>
            <textarea id="postContents" name="contents" rows="4" required></textarea><br>
            <div class="image-upload-div">
                <label for="newPostImage">이미지 업로드:</label>
                <input type="file" id="newPostImage" name="newPostImage"><br>
                <img id="imagePreview">
            </div>
            <button type="button" id="writePostButton">수정</button>
            <button type="button" id="cancelButton">취소</button>
        </form>
    </div>
</div>
</body>

<script>
    $(document).ready(function() {
        // 인기검색어 데이터를 가져와서 HTML에 렌더링하는 함수
        function renderPopularSearches(data) {
            var searchRanking = $(".search-ranking");
            searchRanking.empty(); // 기존 목록 비우기

            $.each(data, function(index, popularSearch) {
                var listItem = $("<li>").text(popularSearch.keyword);
                listItem.on("click", function() {
                    // 검색어 클릭 시 검색 결과 페이지로 이동
                    var keyword = encodeURIComponent(popularSearch.keyword);
                    var searchType = "titleAndContents"; // 예시로 제목+내용 검색 유형 사용
                    window.location.href = "/view/searchKeyword?searchType=" + searchType + "&keyword=" + keyword;
                });
                searchRanking.append(listItem);
            });
        }
        // 백엔드 API 호출하여 인기검색어 데이터 가져오기
        $.ajax({
            url: "/api/popular-searches",
            method: "GET",
            success: function(data) {
                renderPopularSearches(data);
            },
            error: function() {
                console.error("Error fetching popular searches data.");
            }
        });
    });

    var urlParts = window.location.pathname.split("/");
    var postId = urlParts[urlParts.length - 1];

    //게시글 수정페이지 진입시 기존에 있던 내용을 불러와 주는 js
    $.ajax({
        url: "/api/posts/" + postId, // postId는 페이지 URL에서 가져오는 것으로 가정
        method: "GET",
        success: function(response) {
            // 서버에서 가져온 게시글 정보를 폼에 설정
            $("#postTitle").val(response.title);
            $("#postContents").val(response.contents);

            // 게시글 수정 시 이미지를 업로드하려는 경우, 이미지가 설정되어 있다면 이미지 파일명을 표시
            if (response.postImageUrl) {
                $("#newPostImage").val(response.postImageUrl);
            }
        },
        error: function() {
            alert("게시글 정보 가져오기 실패.");
        }
    });

    $(document).ready(function() {
        $("#selectBoardButton").click(function() {
            var boardId = $("#boardId").val();
            if (!boardId) {
                alert("게시판을 선택하세요.");
                return;
            }
            $.ajax({
                url: `/api/boards/` + boardId,
                method: "GET",
                success: function(response) {
                    alert("게시판 선택 완료!");
                    // 게시판 정보에 따라 폼을 수정할 수 있음
                },
                error: function() {
                    alert("게시판 정보 불러오기 실패.");
                }
            });
        });

        $("#newPostImage").change(function() {
            previewImage(this);
        });

        // 이미지 파일 미리보기를 추가하는 함수
        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function(e) {
                    // 이미지 파일 미리보기를 표시할 요소 선택
                    var imagePreview = $("#imagePreview");

                    // 이미지 파일 미리보기 업데이트
                    imagePreview.attr("src", e.target.result);
                };

                // 이미지 파일 읽기
                reader.readAsDataURL(input.files[0]);
            }
        }


        $("#writePostButton").click(function() {
            var boardId = $("#boardId").val();
            if (!boardId) {
                alert("게시판을 먼저 선택하세요.");
                return;
            }
            $("#editPostForm").submit();
        });

        $("#editPostForm").submit(function(event) {
            event.preventDefault();

            var formData = new FormData($("#editPostForm")[0]);
            // FormData 객체 내용 확인
            var newPostImage = formData.get('newPostImage');
            console.log('newPostImage:', newPostImage);

            var url = "/api/boards/" + $("#boardId").val() + "/posts/" + postId;

            var token = Cookies.get('Authorization');
            console.log(token);

            $.ajax({
                url: url,
                method: "PUT",
                headers: {
                    'Authorization': token,
                },
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    console.log('FormData:', formData);
                    console.log('newPostImage:', newPostImage);
                    alert("게시글을 수정하였습니다!");
                    window.location.href = "/view/mainpage"
                },
                error: function() {
                    alert("게시글 수정에 실패했습니다.");
                }
            });
        });

        $("#cancelButton").click(function() {
            window.history.back();
        });
    });
</script>
</html>
